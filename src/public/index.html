<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Leads PRO B2B | Prospecte Clientes no Google Maps</title>
    <meta name="description"
        content="A ferramenta definitiva de prospec√ß√£o B2B. Extraia leads diretamente do Google Maps, incluindo WhatsApp, Instagram e site de empresas em segundos.">
    <meta name="keywords"
        content="extrator de leads, prospectar clientes, leads b2b, extrair contatos, leads google maps, prospec√ß√£o b2b, web scraper leads, whatsapp marketing, vendas">
    <meta name="author" content="LeadsExtractor">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Meta / FB -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Extrator de Leads PRO B2B">
    <meta property="og:description"
        content="Extraia leads altamente qualificados com WhatsApp e Instagram direto do Google Maps. Acelere suas vendas.">

    <!-- Schema.org para Rich Snippets -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "LeadsExtractor PRO",
      "applicationCategory": "BusinessApplication",
      "offers": {
        "@type": "Offer",
        "price": "49.00",
        "priceCurrency": "BRL"
      },
      "description": "Extra√ß√£o de leads corporativos B2B direto do Google Maps com enriquecimento de dados e links sociais."
    }
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- TailwindCSS (CDN tempor√°rio para desenvolvimento r√°pido - idealmente compilar com PostCSS para Produ√ß√£o) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .dark .glass-header {
            background: rgba(15, 23, 42, 0.85);
            border-bottom-color: rgba(51, 65, 85, 0.5);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .custom-shadow {
            box-shadow: 0 4px 24px -8px rgba(0, 0, 0, 0.08);
        }

        .loader {
            border-top-color: transparent;
            animation: spinner 1s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-[#0f172a] text-slate-800 dark:text-slate-200 antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="glass-header sticky top-0 z-40 w-full px-6 py-4 transition-all duration-300">
        <div class="max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">

            <!-- Logo -->
            <div class="flex items-center gap-3">
                <div class="bg-brand-600 text-white p-2.5 rounded-xl shadow-lg shadow-brand-500/30">
                    <i class="ph ph-target text-2xl leading-none"></i>
                </div>
                <div>
                    <span class="text-xl font-bold text-slate-900 dark:text-white tracking-tight leading-none">
                        LeadsExtractor<span class="text-brand-600">.</span></span>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Prospec√ß√£o B2B
                        Inteligente</p>
                </div>
            </div>

            <!-- Auth/User Actions -->
            <div id="auth-section" class="flex items-center gap-3">
                <button onclick="toggleAuthModal(true)"
                    class="text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:text-white font-medium text-sm px-4 py-2 transition-colors">
                    Fazer Login
                </button>
                <button onclick="toggleAuthModal(false)"
                    class="bg-slate-900 dark:bg-indigo-500 hover:bg-slate-800 dark:hover:bg-indigo-600 text-white font-medium text-sm px-5 py-2.5 rounded-xl shadow-md transition-all flex items-center gap-2">
                    Come√ßar Gr√°tis <i class="ph ph-arrow-right"></i>
                </button>
            </div>

            <div id="user-section"
                class="hidden items-center gap-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700/50 p-1.5 rounded-full custom-shadow">

                <div class="flex items-center gap-2 pl-3">
                    <span
                        class="text-xs font-bold px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700/50 tracking-wide"
                        id="user-plan-badge">FREE</span>
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-200 max-w-[120px] truncate"
                        id="user-display"></span>
                </div>

                <button onclick="showPricing()" id="btn-upgrade-header"
                    class="text-xs font-bold text-amber-700 bg-amber-100 hover:bg-amber-200 px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 border-amber-200">
                    <i class="ph-fill ph-crown"></i> PRO
                </button>

                <button onclick="toggleTheme()"
                    class="text-slate-600 dark:text-slate-300 dark:text-slate-400 hover:text-brand-600 dark:hover:text-brand-400 hover:bg-slate-100 dark:bg-slate-800 dark:hover:bg-slate-700 p-2 rounded-full transition-colors"
                    title="Modo Escuro"><i id="theme-icon" class="ph ph-moon text-lg"></i></button>
                <button onclick="showSearches()"
                    class="text-slate-600 dark:text-slate-300 hover:text-brand-600 hover:bg-slate-100 dark:bg-slate-800 dark:hover:bg-slate-700 p-2 rounded-full transition-colors"
                    title="Meu Hist√≥rico">
                    <i class="ph ph-clock-counter-clockwise text-lg"></i>
                </button>

                <button onclick="logout()"
                    class="text-slate-600 dark:text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 dark:bg-slate-800 dark:hover:bg-slate-700 rounded-full transition-colors mr-1"
                    title="Sair">
                    <i class="ph ph-sign-out text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 w-full max-w-5xl mx-auto px-6 py-12 flex flex-col items-center">

        <!-- Hero Section -->
        <div class="text-center max-w-3xl mb-10 animate-slide-up">
            <h1
                class="text-4xl md:text-5xl font-extrabold text-slate-900 dark:text-white tracking-tight mb-4 line-tight">
                Encontre seus pr√≥ximos clientes em <span
                    class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-indigo-500">segundos</span>
            </h1>
            <p class="text-lg text-slate-600 dark:text-slate-300 mb-8 max-w-2xl mx-auto">
                Transforme o Google Maps em sua m√°quina de vendas. Extraia contatos, WhatsApp e Instagram de empresas
                locais rapidamente.
            </p>
        </div>

        <div class="w-full max-w-3xl bg-white dark:bg-slate-800 rounded-3xl p-3 sm:p-4 custom-shadow border-slate-100 dark:border-slate-700/50 mb-12 animate-slide-up"
            style="animation-delay: 0.1s;">
            <form id="extract-form" action="javascript:void(0);" class="flex flex-col sm:flex-row gap-3">
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="ph ph-magnifying-glass text-slate-400 dark:text-slate-500 text-xl"></i>
                    </div>
                    <input type="text" id="query" name="query" placeholder="Ex: Cl√≠nicas odontol√≥gicas em S√£o Paulo"
                        required
                        class="w-full pl-12 pr-4 py-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-transparent focus:bg-white dark:bg-slate-800 focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 text-slate-800 dark:text-slate-100 placeholder-slate-400 text-lg transition-all outline-none">
                </div>
                <button type="submit" id="btn-submit"
                    class="bg-brand-600 hover:bg-brand-700 text-white font-semibold py-4 px-8 rounded-2xl transition-all duration-300 flex items-center justify-center gap-2 shadow-lg shadow-brand-500/25 whitespace-nowrap">
                    <span>Extrair Leads</span>
                    <i class="ph ph-sparkle text-xl"></i>
                </button>
            </form>
        </div>

        <!-- Limits / Error Alerts -->
        <div class="w-full max-w-5xl space-y-4">

            <!-- Loading -->
            <div id="loading"
                class="hidden py-16 flex flex-col items-center justify-center bg-white dark:bg-slate-800 rounded-3xl border-slate-100 dark:border-slate-700/50 custom-shadow animate-fade-in">
                <div class="relative w-16 h-16 mb-6">
                    <div class="absolute inset-0 border-4 border-slate-100 dark:border-slate-700/50 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-brand-500 rounded-full loader border-t-brand-500">
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center text-brand-500">
                        <i class="ph-fill ph-robot text-2xl animate-pulse"></i>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-2">Minerando dados...</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm text-center max-w-md">Buscando
                    empresas, acessando sites e cruzando
                    informa√ß√µes de redes sociais. O processo pode levar alguns instantes.</p>
            </div>

            <!-- Error List -->
            <div id="error"
                class="hidden p-5 bg-red-50 dark:bg-red-900/20 rounded-2xl border-red-100 dark:border-red-900/50 flex items-start gap-4 animate-fade-in">
                <div class="bg-red-100 dark:bg-red-900/50 p-2 rounded-full text-red-600 dark:text-red-400 shrink-0">
                    <i class="ph ph-warning-circle text-xl"></i>
                </div>
                <div>
                    <h3 class="font-bold text-red-800 dark:text-red-400">Falha na extra√ß√£o</h3>
                    <p id="error-message" class="text-sm text-red-600 dark:text-red-300 mt-1"></p>
                </div>
            </div>

            <!-- Upgrade Warning Limit -->
            <div id="limit-warning"
                class="hidden p-8 bg-gradient-to-br from-amber-50 to-orange-50 rounded-3xl border-amber-200 flex flex-col items-center text-center gap-4 custom-shadow animate-slide-up">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-full shadow-sm text-amber-500">
                    <i class="ph-fill ph-lock-key text-4xl"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-900 dark:text-white text-2xl mb-2">Limite Gratuito Atingido</h3>
                    <p id="limit-message" class="text-slate-600 dark:text-slate-300 max-w-lg mx-auto">Voc√™ j√° utilizou
                        sua busca gratuita.
                        Para continuar prospectando leads e ter acesso aos filtros avan√ßados, libere o acesso PRO!</p>
                </div>
                <button onclick="showPricing()"
                    class="mt-4 bg-slate-900 dark:bg-indigo-500 hover:bg-slate-800 dark:hover:bg-indigo-600 text-white font-semibold py-3 px-8 rounded-xl shadow-lg transition-all flex items-center gap-2 hover:-translate-y-0.5">
                    <i class="ph ph-rocket-launch"></i> Ver Planos e Fazer Upgrade
                </button>
            </div>

            <!-- Results -->
            <div id="results" class="hidden flex-col gap-6 animate-fade-in w-full">

                <!-- Action Bar -->
                <div
                    class="flex flex-col md:flex-row items-center justify-between gap-4 bg-white dark:bg-slate-800 p-4 sm:p-5 rounded-2xl custom-shadow border-slate-100 dark:border-slate-700/50">

                    <div class="flex items-center gap-3">
                        <div
                            class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 p-2 rounded-xl">
                            <i class="ph-fill ph-check-circle text-xl leading-none"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">Extra√ß√£o
                                Conclu√≠da</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 font-medium whitespace-nowrap">
                                <span id="results-count" class="text-brand-600 font-bold">0</span> leads coletados
                            </p>
                        </div>
                    </div>

                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="downloadJSON()"
                            class="flex-1 md:flex-none justify-center text-sm bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 font-medium py-2.5 px-4 rounded-xl transition-colors flex items-center gap-2">
                            <i class="ph ph-code"></i> JSON
                        </button>
                        <button onclick="downloadCSV()"
                            class="flex-1 md:flex-none justify-center text-sm bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2.5 px-5 rounded-xl transition-colors flex items-center gap-2 shadow-sm shadow-emerald-500/20">
                            <i class="ph ph-download-simple"></i> Baixar CSV
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div
                    class="bg-white dark:bg-slate-800 p-5 rounded-2xl border-slate-100 dark:border-slate-700/50 custom-shadow flex flex-col gap-4">
                    <div class="flex items-center gap-2 text-slate-800 dark:text-slate-100 font-semibold text-sm mb-1">
                        <i class="ph ph-funnel"></i> Filtrar Resultados
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">üåê
                                Site</label>
                            <select id="filter-web" onchange="applyFilters()"
                                class="w-full text-sm bg-slate-50 dark:bg-slate-800/50 rounded-xl border-slate-200 dark:border-slate-700/50 focus:border-brand-500 focus:ring-brand-500 focus:bg-white dark:bg-slate-800 p-3 border dark:border-slate-700/50 outline-none disabled:opacity-50 transition-colors">
                                <option value="all">Todos os resultados</option>
                                <option value="yes">Apenas com Site</option>
                                <option value="no">Sem Site</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">üì∏
                                Instagram</label>
                            <select id="filter-insta" onchange="applyFilters()"
                                class="w-full text-sm bg-slate-50 dark:bg-slate-800/50 rounded-xl border-slate-200 dark:border-slate-700/50 focus:border-brand-500 focus:ring-brand-500 focus:bg-white dark:bg-slate-800 p-3 border dark:border-slate-700/50 outline-none disabled:opacity-50 transition-colors">
                                <option value="all">Todos os resultados</option>
                                <option value="yes">Apenas com Instagram</option>
                                <option value="no">Sem Instagram</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">üí¨
                                WhatsApp</label>
                            <select id="filter-wpp" onchange="applyFilters()"
                                class="w-full text-sm bg-slate-50 dark:bg-slate-800/50 rounded-xl border-slate-200 dark:border-slate-700/50 focus:border-brand-500 focus:ring-brand-500 focus:bg-white dark:bg-slate-800 p-3 border dark:border-slate-700/50 outline-none disabled:opacity-50 transition-colors">
                                <option value="all">Todos os resultados</option>
                                <option value="yes">Apenas com WhatsApp</option>
                                <option value="no">Sem WhatsApp</option>
                            </select>
                        </div>
                    </div>

                    <!-- Pro Upsell para Filtros -->
                    <div id="filter-pro-upsell"
                        class="hidden w-full bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800/50 p-3 text-amber-800 dark:text-amber-400 text-sm rounded-xl mt-2 flex flex-col sm:flex-row items-center justify-between gap-3">
                        <div class="flex items-center gap-2">
                            <i class="ph-fill ph-lock-key text-amber-500 text-lg"></i>
                            <span>Filtros avan√ßados bloqueados no Plano Gr√°tis.</span>
                        </div>
                        <button onclick="showPricing()"
                            class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-1.5 px-4 rounded-lg text-xs transition-colors whitespace-nowrap">
                            Desbloquear PRO
                        </button>
                    </div>
                </div>

                <!-- Table Data -->
                <div
                    class="overflow-x-auto rounded-2xl border-slate-200 dark:border-slate-700/50 bg-white dark:bg-slate-800 custom-shadow">
                    <table class="min-w-full divide-y divide-slate-200 text-sm text-left">
                        <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 font-semibold">
                            <tr>
                                <th class="px-6 py-4 uppercase tracking-wider text-xs">Empresa & Endere√ßo</th>
                                <th class="px-6 py-4 uppercase tracking-wider text-xs">Contatos</th>
                                <th class="px-6 py-4 uppercase tracking-wider text-xs">Presen√ßa Digital</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="bg-white dark:bg-slate-800 divide-y divide-slate-100">
                            <!-- Injetado via JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="pagination"
                    class="hidden flex flex-col sm:flex-row items-center justify-between bg-white dark:bg-slate-800/80 px-6 py-4 rounded-2xl border-slate-200 dark:border-slate-700/50 custom-shadow gap-4">
                    <p class="text-sm text-slate-600 dark:text-slate-300">
                        Mostrando <span id="page-start" class="font-bold text-slate-900 dark:text-white">1</span> -
                        <span id="page-end" class="font-bold text-slate-900 dark:text-white">20</span> de <span
                            id="page-total" class="font-bold text-slate-900 dark:text-white">0</span> leads
                    </p>
                    <nav
                        class="flex items-center gap-1 bg-slate-50 dark:bg-slate-800/50 p-1 rounded-xl border-slate-200 dark:border-slate-700/50">
                        <button id="btn-prev-page"
                            class="p-2 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:text-white hover:bg-white dark:bg-slate-800 rounded-lg transition-colors disabled:opacity-50 disabled:hover:bg-transparent"><i
                                class="ph ph-caret-left text-lg leading-none"></i></button>
                        <span id="page-indicator"
                            class="px-3 py-1 text-sm font-semibold text-slate-700 dark:text-slate-200">1 / 1</span>
                        <button id="btn-next-page"
                            class="p-2 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:text-white hover:bg-white dark:bg-slate-800 rounded-lg transition-colors disabled:opacity-50 disabled:hover:bg-transparent"><i
                                class="ph ph-caret-right text-lg leading-none"></i></button>
                    </nav>
                </div>

            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="w-full border-t border-slate-200 dark:border-slate-700/50 bg-white dark:bg-slate-800 py-6 mt-auto">
        <div class="max-w-6xl mx-auto px-6 flex flex-col sm:flex-row items-center justify-between gap-4">
            <p class="text-sm text-slate-500 dark:text-slate-400">¬© 2026 LeadsExtractor PRO. Todos
                os direitos reservados.</p>
            <div class="flex gap-4 text-slate-400 dark:text-slate-500">
                <a href="#" class="hover:text-slate-600 dark:text-slate-300 transition-colors"><i
                        class="ph-fill ph-instagram-logo text-xl"></i></a>
                <a href="#" class="hover:text-slate-600 dark:text-slate-300 transition-colors"><i
                        class="ph-fill ph-envelope-simple text-xl"></i></a>
            </div>
        </div>
    </footer>


    <!-- MODAIS -->

    <!-- Backdrop Blur (Compartilhado) -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 transition-opacity">
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md p-8 relative overflow-hidden animate-slide-up">

            <button onclick="closeModals()"
                class="absolute top-5 right-5 text-slate-400 dark:text-slate-500 hover:text-slate-700 dark:text-slate-200 bg-slate-50 dark:bg-slate-900 hover:bg-slate-100 dark:bg-slate-700 rounded-full p-2 transition-colors">
                <i class="ph ph-x text-lg leading-none"></i>
            </button>

            <!-- Persuasion Box -->
            <div id="auth-persuasion"
                class="hidden mb-6 bg-brand-50 dark:bg-brand-900/20 border-brand-100 dark:border-brand-800/50 p-4 rounded-2xl flex gap-3 text-brand-800 dark:text-brand-300">
                <div class="bg-brand-100 dark:bg-brand-900/50 p-2 rounded-full h-fit"><i
                        class="ph-fill ph-gift text-brand-600 dark:text-brand-400"></i></div>
                <div>
                    <strong class="block mb-1 text-sm">Libere sua busca gratuita!</strong>
                    <p class="text-xs opacity-90 leading-relaxed">Crie uma conta rapidamente para testar o extrator com
                        limite de 5 leads agora mesmo.</p>
                </div>
            </div>

            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2" id="auth-title">Bem-vindo de volta
                </h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm" id="auth-desc">Fa√ßa login para
                    acessar sua conta.</p>
            </div>

            <div id="auth-error"
                class="hidden mb-5 p-3 bg-red-50 text-red-700 text-sm rounded-xl border-red-100 text-center font-medium">
            </div>

            <form id="auth-form" class="space-y-4">
                <div>
                    <label
                        class="block text-sm font-semibold text-slate-700 dark:text-slate-200 mb-1.5 ml-1">E-mail</label>
                    <input type="email" id="auth-email" required placeholder="seu@email.com"
                        class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700/50 focus:bg-white dark:bg-slate-800 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all">
                </div>
                <div>
                    <label
                        class="block text-sm font-semibold text-slate-700 dark:text-slate-200 mb-1.5 ml-1">Senha</label>
                    <input type="password" id="auth-pass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700/50 focus:bg-white dark:bg-slate-800 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all">
                </div>
                <button type="submit" id="auth-btn"
                    class="w-full bg-slate-900 dark:bg-indigo-500 hover:bg-slate-800 dark:hover:bg-indigo-600 text-white font-bold py-3.5 rounded-xl transition-all shadow-md mt-2 flex justify-center items-center gap-2">
                    Entrar na Plataforma
                </button>
            </form>

            <div class="mt-8 text-center text-sm">
                <span class="text-slate-500 dark:text-slate-400" id="auth-toggle-text">Ainda n√£o tem
                    conta?</span>
                <button type="button" onclick="toggleAuthMode()"
                    class="text-brand-600 hover:text-brand-700 font-bold ml-1 hover:underline decoration-2 underline-offset-2 transition-all"
                    id="auth-toggle-btn">
                    Criar conta gr√°tis
                </button>
            </div>
        </div>
    </div>


    <!-- Pricing Modal -->
    <div id="pricing-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-4xl relative overflow-hidden animate-slide-up flex flex-col md:flex-row">

            <button onclick="closeModals()"
                class="absolute top-4 right-4 text-slate-400 dark:text-slate-500 hover:text-slate-700 dark:text-slate-200 z-10 bg-white dark:bg-slate-800/80 backdrop-blur rounded-full p-2 transition-colors">
                <i class="ph ph-x text-lg leading-none"></i>
            </button>

            <div
                class="md:w-1/2 bg-slate-900 p-8 md:p-12 text-white flex flex-col justify-center relative overflow-hidden">
                <!-- BG Decoration -->
                <div class="absolute -top-24 -right-24 w-64 h-64 bg-brand-500 rounded-full blur-[80px] opacity-30">
                </div>

                <h2 id="pricing-title-span" class="text-3xl font-extrabold mb-4 relative z-10">Desbloqueie o<br><span
                        class="text-amber-400">Poder Total.</span></h2>
                <p class="text-slate-300 text-sm mb-8 leading-relaxed relative z-10">Pare de perder tempo abrindo sites
                    um por um. Encontre leads qualificados, filtre contatos de WhatsApp e exporte sem limites.</p>

                <ul class="space-y-4 relative z-10">
                    <li class="flex items-start gap-3 text-sm font-medium"><i
                            class="ph-fill ph-check-circle text-amber-400 text-xl shrink-0"></i> Buscas Ilimitadas no
                        Google Maps</li>
                    <li class="flex items-start gap-3 text-sm font-medium"><i
                            class="ph-fill ph-check-circle text-amber-400 text-xl shrink-0"></i> Captura ilimitada de
                        Leads por pesquisa</li>
                    <li class="flex items-start gap-3 text-sm font-medium"><i
                            class="ph-fill ph-check-circle text-amber-400 text-xl shrink-0"></i> Filtros Ativos (Canais
                        Web, Whats, Insta)</li>
                    <li class="flex items-start gap-3 text-sm font-medium"><i
                            class="ph-fill ph-check-circle text-amber-400 text-xl shrink-0"></i> Hist√≥rico salvo
                        permanentemente na nuvem</li>
                </ul>
            </div>

            <div
                class="md:w-1/2 p-8 md:p-12 flex flex-col justify-center items-center text-center bg-white dark:bg-slate-800">
                <div
                    class="bg-amber-100 text-amber-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-6 border-amber-200">
                    Acesso PRO
                </div>

                <div class="flex items-baseline justify-center gap-1 mb-2">
                    <span class="text-xl font-bold text-slate-400 dark:text-slate-500">R$</span>
                    <span class="text-6xl font-extrabold text-slate-900 dark:text-white tracking-tighter">49</span>
                    <span class="text-lg font-medium text-slate-500 dark:text-slate-400">/m√™s</span>
                </div>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">Cancele quando quiser.
                    Sem fidelidade.</p>

                <div id="pricing-cta-container" class="w-full">
                    <!-- Din√¢mico via JS -->
                </div>

                <div
                    class="flex items-center justify-center gap-2 text-xs text-slate-400 dark:text-slate-500 font-medium pt-2">
                    <i class="ph-fill ph-lock-key"></i> Pagamento 100% Seguro
                </div>
            </div>
        </div>
    </div>


    <!-- History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col relative animate-slide-up">

            <div
                class="p-6 border-b border-slate-100 dark:border-slate-700/50 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50 rounded-t-3xl">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <div class="bg-slate-200 dark:bg-slate-600 p-1.5 rounded-lg"><i
                            class="ph ph-clock-counter-clockwise text-slate-700 dark:text-slate-200"></i></div>
                    Meu Hist√≥rico
                </h2>
                <button onclick="closeModals()"
                    class="text-slate-400 dark:text-slate-500 hover:text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-800 rounded-full p-2 border-slate-200 dark:border-slate-700/50 shadow-sm transition-colors">
                    <i class="ph ph-x text-sm leading-none"></i>
                </button>
            </div>

            <div class="p-4 sm:p-6 overflow-y-auto" id="history-content">
                <!-- Loader -->
                <div class="flex justify-center py-12">
                    <div
                        class="loader rounded-full border-4 border-slate-200 dark:border-slate-700/50 border-t-brand-500 h-10 w-10">
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Cancel Modal -->
    <div id="cancel-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-sm relative animate-slide-up p-8 text-center text-slate-800 dark:text-slate-100 border border-slate-100 dark:border-slate-700/50">
            <div class="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-4 rounded-full inline-flex mb-5">
                <i class="ph-fill ph-warning-circle text-4xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-3 text-slate-900 dark:text-white">Cancelar Plano?</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-8 text-sm leading-relaxed">Voc√™ perder√° o acesso ilimitado
                √†s buscas avan√ßadas, exporta√ß√µes r√°pidas e leitura de hist√≥rico em nuvem. Tem certeza?</p>

            <div class="flex gap-3 w-full">
                <button onclick="closeCancelModal()"
                    class="flex-1 py-3 px-4 rounded-2xl font-semibold bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 transition-colors">Voltar</button>
                <button onclick="updateSubscription('cancel')" id="btn-confirm-cancel"
                    class="flex-1 py-3 px-4 rounded-2xl font-semibold bg-red-600 hover:bg-red-700 text-white shadow-lg shadow-red-500/20 transition-all flex items-center justify-center gap-2">Finalizar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="hidden fixed bottom-6 right-6 z-[100] transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 bg-slate-900 dark:bg-slate-800 text-white pl-4 pr-6 py-3.5 rounded-2xl shadow-xl shadow-slate-900/20 border border-slate-700/50">
        <i id="toast-icon" class="ph-fill ph-check-circle text-2xl text-emerald-400"></i>
        <p id="toast-message" class="text-sm font-medium tracking-wide"></p>
    </div>

    <script>
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            toastMsg.textContent = message;
            if (type === 'success') {
                toastIcon.className = 'ph-fill ph-check-circle text-2xl text-emerald-400';
            } else {
                toastIcon.className = 'ph-fill ph-warning-circle text-2xl text-red-400';
            }

            toast.classList.remove('hidden');
            // Give a tiny delay for CSS transition
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 4000);
        }

        // Dark Mode Setup
        const html = document.documentElement;
        let theme = localStorage.getItem('theme');
        if (!theme) {
            theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        if (theme === 'dark') {
            html.classList.add('dark');
        }

        function toggleTheme() {
            html.classList.toggle('dark');
            if (html.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
                document.getElementById('theme-icon').className = 'ph ph-sun text-lg';
            } else {
                localStorage.setItem('theme', 'light');
                document.getElementById('theme-icon').className = 'ph ph-moon text-lg';
            }
        }

        // ESTADO GLOBAL
        let currentLeads = [];
        let filteredLeads = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let isLoginMode = true;
        let userPlan = 'free';

        // INICIALIZA√á√ÉO
        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const isSuccess = params.get('payment') === 'success';
            const isCanceled = params.get('payment') === 'error';

            if (isSuccess) showToast('üéâ Pagamento conclu√≠do! Voc√™ agora √© PRO!', 'success');
            if (isCanceled) showToast('Houve um erro no pagamento.', 'error');

            // Remove query params from URL if form submitted normally by mistake
            if (window.location.search) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            const token = localStorage.getItem('token');
            if (token) {
                await fetchUserDetails(token);
            }
        });

        // ---------------- AUTH E SESS√ÉO ----------------

        async function fetchUserDetails(token) {
            try {
                const res = await fetch('/api/me', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success && data.user) {
                    userPlan = data.user.plan || 'free';
                    updateUIAuth(data.user.email, userPlan);
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error fetching user info', error);
            }
        }

        function updateUIAuth(email, plan) {
            document.getElementById('auth-section').classList.add('hidden');

            const userSec = document.getElementById('user-section');
            userSec.classList.remove('hidden');
            userSec.classList.add('flex');

            document.getElementById('user-display').textContent = email;

            const pBadge = document.getElementById('user-plan-badge');
            const btnUpgrade = document.getElementById('btn-upgrade-header');

            if (plan === 'pro') {
                pBadge.textContent = 'PRO';
                pBadge.className = 'text-xs font-bold px-2.5 py-1 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 border-amber-200 tracking-wide';
                btnUpgrade.innerHTML = '<i class="ph-fill ph-crown text-lg"></i>';
            } else {
                pBadge.textContent = 'FREE';
                pBadge.className = 'text-xs font-bold px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700/50 tracking-wide';
                btnUpgrade.innerHTML = '<i class="ph-fill ph-crown"></i> PRO';
            }
            btnUpgrade.classList.remove('hidden');
            closeModals();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userEmail');
            userPlan = 'free';

            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('user-section').classList.remove('flex');
            document.getElementById('auth-section').classList.remove('hidden');

            // Limpa dados e reseta interface
            currentLeads = [];
            document.getElementById('results').classList.add('hidden');
            document.getElementById('limit-warning').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('query').value = '';
        }

        // ---------------- MODAIS ----------------

        function showBackdrop() {
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        function closeModals() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('pricing-modal').classList.add('hidden');
            document.getElementById('history-modal').classList.add('hidden');
            document.getElementById('cancel-modal').classList.add('hidden');
        }

        function toggleAuthModal(isLogin = true, showBox = false) {
            closeModals();
            isLoginMode = isLogin;
            updateAuthModalUI();

            if (showBox) {
                document.getElementById('auth-persuasion').classList.remove('hidden');
            } else {
                document.getElementById('auth-persuasion').classList.add('hidden');
            }

            showBackdrop();
            document.getElementById('auth-modal').classList.remove('hidden');
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            updateAuthModalUI();
        }

        function updateAuthModalUI() {
            document.getElementById('auth-title').textContent = isLoginMode ? 'Bem-vindo de volta' : 'Crie sua conta';
            document.getElementById('auth-desc').textContent = isLoginMode ? 'Fa√ßa login para acessar sua conta.' : 'Ganhe uma busca gratuita para testar o extrator.';
            document.getElementById('auth-btn').innerHTML = isLoginMode ? 'Entrar na Plataforma' : 'Criar Conta Gr√°tis';
            document.getElementById('auth-toggle-text').textContent = isLoginMode ? 'Ainda n√£o tem conta?' : 'J√° possui uma conta?';
            document.getElementById('auth-toggle-btn').textContent = isLoginMode ? 'Criar conta gr√°tis' : 'Fazer login';
            document.getElementById('auth-error').classList.add('hidden');
        }

        function showPricing() {
            closeModals();
            showBackdrop();

            const titleSpan = document.getElementById('pricing-title-span');
            const ctaContainer = document.getElementById('pricing-cta-container');

            if (userPlan === 'pro') {
                if (titleSpan) titleSpan.innerHTML = 'Sua <br><span class="text-emerald-400">Assinatura PRO.</span>';
                ctaContainer.innerHTML = `
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 p-3 rounded-xl text-sm font-semibold mb-6 border border-emerald-100 dark:border-emerald-800/50 flex flex-col items-center">
                        <i class="ph-fill ph-check-circle text-2xl mb-1 mt-2"></i>
                        Assinatura PRO Ativa
                    </div>
                    <button class="w-full bg-slate-100 hover:bg-red-50 dark:bg-slate-800 dark:hover:bg-red-900/30 text-slate-600 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400 font-bold py-3.5 px-6 rounded-2xl transition-all mb-4 border border-slate-200 dark:border-slate-700 dark:border-slate-700/50 hover:border-red-200 dark:hover:border-red-800/50" onclick="showCancelModal()"> Cancelar Assinatura </button>
                `;
            } else {
                if (titleSpan) titleSpan.innerHTML = 'Desbloqueie o<br><span class="text-amber-400">Poder Total.</span>';
                ctaContainer.innerHTML = `
                    <button class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 px-6 rounded-2xl shadow-xl shadow-brand-500/30 transition-all hover:-translate-y-1 mb-4" onclick="updateSubscription('upgrade')">Assinar Agora</button>
                `;
            }

            document.getElementById('pricing-modal').classList.remove('hidden');
        }

        function showCancelModal() {
            closeModals();
            showBackdrop();
            document.getElementById('cancel-modal').classList.remove('hidden');
        }

        function closeCancelModal() {
            closeModals();
            showPricing(); // Retorna √† tela de planos se desistir
        }

        async function updateSubscription(action) {
            const token = localStorage.getItem('token');
            if (!token) return toggleAuthModal(true);

            try {
                const btn = event.target;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="ph ph-spinner animate-spin text-xl"></i> Processando...';
                btn.disabled = true;

                if (action === 'upgrade') {
                    const res = await fetch('/api/create-checkout-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();

                    if (data.success && data.url) {
                        window.location.href = data.url; // Redireciona para o Stripe
                    } else {
                        showToast(data.message || 'Erro ao iniciar checkout.', 'error');
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                    }
                } else if (action === 'cancel') {
                    const res = await fetch('/api/subscription/cancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
                    });

                    const data = await res.json();

                    if (data.success) {
                        userPlan = data.plan; // Atualiza plano da sessao localmente
                        updateUIAuth(localStorage.getItem('userEmail'), userPlan);
                        showToast(data.message, 'success');
                        closeModals();
                        applyFilters(); // Re-aplica filtros (pode bloque√°-los se virou free)
                    } else {
                        showToast(data.message || 'Erro ao cancelar assinatura.', 'error');
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                    }
                }
            } catch (err) {
                showToast('Erro de Conex√£o. Verifique a internet e tente novamente.', 'error');
            }
        }

        // ---------------- FORMUL√ÅRIOS E REQUISI√á√ïES ----------------

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-pass').value;
            const endpoint = isLoginMode ? '/api/login' : '/api/register';
            const errorDiv = document.getElementById('auth-error');
            const btn = document.getElementById('auth-btn');

            const btnOriginalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin text-xl"></i> Processando...';

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (!res.ok || !data.success) {
                    throw new Error(data.message || 'Erro de autentica√ß√£o');
                }

                if (!isLoginMode) {
                    // Ap√≥s registro, loga autom√°tico pra fluir melhor
                    const loginRes = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const loginData = await loginRes.json();

                    if (loginRes.ok) {
                        localStorage.setItem('token', loginData.token);
                        localStorage.setItem('userEmail', loginData.user.email);
                        userPlan = loginData.user.plan || 'free';
                        updateUIAuth(loginData.user.email, userPlan);
                    } else {
                        throw new Error("Conta criada, mas erro ao logar automaticamente. Tente logar.");
                    }
                } else {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('userEmail', data.user.email);
                    userPlan = data.user.plan || 'free';
                    updateUIAuth(data.user.email, userPlan);
                }
            } catch (error) {
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = error.message;
            } finally {
                btn.disabled = false;
                btn.innerHTML = btnOriginalHtml;
            }
        });

        document.getElementById('extract-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = localStorage.getItem('token');
            if (!token) {
                return toggleAuthModal(false, true); // Create mode, show persuasion
            }

            const query = document.getElementById('query').value;
            if (!query) return;

            // Get UI Elms
            const submitBtn = document.getElementById('btn-submit');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const limitWarning = document.getElementById('limit-warning');
            const resultsDiv = document.getElementById('results');

            errorDiv.classList.add('hidden');
            limitWarning.classList.add('hidden');
            resultsDiv.classList.add('hidden');

            const originalBtnHtml = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-80', 'cursor-not-allowed');
            loading.classList.remove('hidden');

            try {
                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();

                if (response.status === 403 && data.error === 'plan_limit_reached') {
                    limitWarning.classList.remove('hidden');
                    return;
                }

                if (!response.ok || !data.success) {
                    throw new Error(data.error || data.message || 'Erro desconhecido');
                }

                currentLeads = data.data;
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
                applyFilters();
                resultsDiv.classList.remove('hidden');
                resultsDiv.classList.add('flex'); // tailwind overrides

            } catch (err) {
                console.error(err);
                document.getElementById('error-message').textContent = err.message || 'Aconteceu um erro na comunica√ß√£o com o servidor.';
                errorDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-80', 'cursor-not-allowed');
            }
        });

        // ---------------- TABELA, FILTROS E HIST√ìRICO ----------------

        function applyFilters() {
            // Se plano free, trava filtros
            if (userPlan === 'free') {
                document.getElementById('filter-web').disabled = true;
                document.getElementById('filter-insta').disabled = true;
                document.getElementById('filter-wpp').disabled = true;
                document.getElementById('filter-pro-upsell').classList.remove('hidden');
                document.getElementById('filter-pro-upsell').classList.add('flex');
                document.getElementById('filter-web').value = 'all';
                document.getElementById('filter-insta').value = 'all';
                document.getElementById('filter-wpp').value = 'all';
            } else {
                document.getElementById('filter-web').disabled = false;
                document.getElementById('filter-insta').disabled = false;
                document.getElementById('filter-wpp').disabled = false;
                document.getElementById('filter-pro-upsell').classList.add('hidden');
                document.getElementById('filter-pro-upsell').classList.remove('flex');
            }

            const hasWeb = document.getElementById('filter-web').value;
            const hasInsta = document.getElementById('filter-insta').value;
            const hasWpp = document.getElementById('filter-wpp').value;

            filteredLeads = currentLeads.filter(lead => {
                let passWeb = true; let passInsta = true; let passWpp = true;

                if (hasWeb === 'yes') passWeb = lead.website && lead.website !== 'N/A';
                if (hasWeb === 'no') passWeb = !lead.website || lead.website === 'N/A';
                if (hasInsta === 'yes') passInsta = lead.instagram && lead.instagram !== 'N/A' && lead.instagram !== 'N√£o encontrado';
                if (hasInsta === 'no') passInsta = !lead.instagram || lead.instagram === 'N/A' || lead.instagram === 'N√£o encontrado';
                if (hasWpp === 'yes') passWpp = lead.whatsapp && lead.whatsapp !== 'N/A';
                if (hasWpp === 'no') passWpp = !lead.whatsapp || lead.whatsapp === 'N/A';

                return passWeb && passInsta && passWpp;
            });

            document.getElementById('results-count').textContent = filteredLeads.length;
            currentPage = 1;
            renderTablePage(currentPage);
        }

        function renderTablePage(page) {
            const resultsBody = document.getElementById('results-body');
            const paginationDiv = document.getElementById('pagination');

            if (!filteredLeads || filteredLeads.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400 font-medium bg-slate-50 dark:bg-slate-900/50">Nenhum lead compat√≠vel com os filtros selecionados.</td></tr>';
                paginationDiv.classList.add('hidden');
                return;
            }

            const totalPages = Math.ceil(filteredLeads.length / itemsPerPage);
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            currentPage = page;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const leadsPage = filteredLeads.slice(startIndex, endIndex);

            let htmlRows = '';
            leadsPage.forEach(lead => {
                const formatWpp = (num) => {
                    const clean = String(num).replace(/\D/g, '');
                    return `https://wa.me/55${clean}`;
                };

                const wppHtml = lead.whatsapp && lead.whatsapp !== 'N/A'
                    ? `<a href="${formatWpp(lead.whatsapp)}" target="_blank" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-xs font-semibold hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-colors mt-2 w-fit border-emerald-100 dark:border-emerald-800/60"><i class="ph-fill ph-whatsapp-logo text-sm"></i> ${lead.whatsapp}</a>`
                    : '';

                const siteHtml = lead.website && lead.website !== 'N/A'
                    ? `<a href="${lead.website}" target="_blank" class="flex items-center gap-1.5 text-brand-600 dark:text-brand-400 hover:text-brand-800 dark:hover:text-brand-300 text-xs font-semibold hover:underline bg-brand-50 dark:bg-brand-900/30 hover:bg-brand-100 dark:hover:bg-brand-900/50 px-2.5 py-1 rounded-md transition-colors w-fit border-brand-100 dark:border-brand-800/60"><i class="ph-bold ph-globe"></i> Acessar Site</a>`
                    : '<span class="text-slate-400 dark:text-slate-500 text-xs italic px-2">Sem Website</span>';

                const instHtml = lead.instagram && lead.instagram !== 'N/A' && lead.instagram !== 'N√£o encontrado'
                    ? `<a href="${lead.instagram}" target="_blank" class="flex items-center gap-1.5 text-pink-600 dark:text-pink-400 hover:text-pink-800 dark:hover:text-pink-300 text-xs font-semibold hover:underline bg-pink-50 dark:bg-pink-900/30 hover:bg-pink-100 dark:hover:bg-pink-900/50 px-2.5 py-1 rounded-md transition-colors w-fit border-pink-100 dark:border-pink-800/60 mt-2"><i class="ph-bold ph-instagram-logo"></i> Instagram</a>`
                    : '';

                htmlRows += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group">
                        <td class="px-6 py-4 border-b border-slate-100 dark:border-slate-700/50">
                            <div class="font-bold text-slate-800 dark:text-slate-100 mb-1 line-clamp-2 leading-tight">${lead.nome}</div>
                            <div class="text-slate-500 dark:text-slate-400 text-xs line-clamp-2" title="${lead.endereco}"><i class="ph-fill ph-map-pin mr-0.5"></i> ${lead.endereco}</div>
                        </td>
                        <td class="px-6 py-4 border-b border-slate-100 dark:border-slate-700/50 align-top">
                            <div class="text-slate-700 dark:text-slate-200 text-sm font-medium flex items-center gap-1.5"><i class="ph-fill ph-phone text-slate-400 dark:text-slate-500"></i> ${lead.telefone || '<span class="text-slate-400 dark:text-slate-500 italic font-normal text-xs">Pendente</span>'}</div>
                            ${wppHtml}
                        </td>
                        <td class="px-6 py-4 border-b border-slate-100 dark:border-slate-700/50 align-top">
                            <div class="flex flex-col gap-1.5">
                                ${siteHtml}
                                ${instHtml}
                            </div>
                        </td>
                    </tr>
                `;
            });

            resultsBody.innerHTML = htmlRows;

            if (totalPages > 1) {
                paginationDiv.classList.remove('hidden');
                paginationDiv.classList.add('flex');

                document.getElementById('page-start').textContent = startIndex + 1;
                document.getElementById('page-end').textContent = Math.min(endIndex, filteredLeads.length);
                document.getElementById('page-total').textContent = filteredLeads.length;
                document.getElementById('page-indicator').textContent = `${currentPage} / ${totalPages}`;

                const btnPrev = document.getElementById('btn-prev-page');
                const btnNext = document.getElementById('btn-next-page');

                btnPrev.disabled = currentPage === 1;
                btnNext.disabled = currentPage === totalPages;

                btnPrev.onclick = () => { renderTablePage(currentPage - 1); document.getElementById('results').scrollIntoView({ behavior: 'smooth' }); };
                btnNext.onclick = () => { renderTablePage(currentPage + 1); document.getElementById('results').scrollIntoView({ behavior: 'smooth' }); };
            } else {
                paginationDiv.classList.add('hidden');
                paginationDiv.classList.remove('flex');
            }
        }

        async function showSearches() {
            const token = localStorage.getItem('token');
            if (!token) {
                return toggleAuthModal(true);
            }

            closeModals();
            showBackdrop();
            document.getElementById('history-modal').classList.remove('hidden');
            const content = document.getElementById('history-content');
            content.innerHTML = '<div class="flex justify-center py-12"><div class="loader rounded-full border-4 border-slate-200 dark:border-slate-700/50 border-t-brand-500 h-10 w-10"></div></div>';

            try {
                const res = await fetch('/api/searches', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                if (!res.ok || !data.success) throw new Error(data.message);

                if (data.searches.length === 0) {
                    content.innerHTML = `
                        <div class="text-center py-16 px-4">
                            <div class="bg-slate-100 dark:bg-slate-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400 dark:text-slate-500">
                                <i class="ph ph-folder-open text-3xl"></i>
                            </div>
                            <h3 class="text-slate-800 dark:text-slate-100 font-bold text-lg">Nenhum hist√≥rico</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Voc√™ ainda n√£o realizou nenhuma extra√ß√£o de leads.</p>
                        </div>`;
                    return;
                }

                let html = '<div class="grid grid-cols-1 gap-3">';
                data.searches.forEach(search => {
                    const dateObj = new Date(search.created_at);
                    const formattedDate = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                    const formattedTime = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                    html += `
                        <div class="bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700/50 rounded-2xl p-4 flex flex-col sm:flex-row sm:items-center justify-between hover:border-brand-300 hover:shadow-md transition-all gap-4 group">
                            <div class="flex items-start gap-4 overflow-hidden">
                                <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl text-slate-400 dark:text-slate-500 group-hover:text-brand-500 dark:group-hover:text-brand-400 group-hover:bg-brand-50 dark:group-hover:bg-brand-900/30 transition-colors shrink-0">
                                    <i class="ph-fill ph-magnifying-glass text-xl"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <h4 class="font-bold text-slate-800 dark:text-slate-100 truncate mb-1" title="${search.query}">${search.query}</h4>
                                    <div class="flex gap-3 text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wide">
                                        <span class="flex items-center gap-1"><i class="ph ph-calendar-blank"></i> ${formattedDate}</span>
                                        <span class="flex items-center gap-1"><i class="ph ph-clock"></i> ${formattedTime}</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="loadPastSearch(${search.id}, '${search.query}')" class="bg-slate-50 dark:bg-slate-900 hover:bg-brand-50 text-slate-600 dark:text-slate-300 hover:text-brand-600 border-slate-200 dark:border-slate-700/50 hover:border-brand-200 px-4 py-2.5 rounded-xl text-sm font-semibold transition-colors whitespace-nowrap flex items-center justify-center gap-2">
                                <i class="ph ph-list-dashes"></i> Ver Leads
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                content.innerHTML = html;

            } catch (error) {
                content.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded-xl font-medium border-red-100 flex items-center gap-2"><i class="ph ph-warning-circle text-xl"></i> Erro ao carregar hist√≥rico: ${error.message}</div>`;
            }
        }

        async function loadPastSearch(searchId, queryName) {
            const token = localStorage.getItem('token');
            closeModals();

            document.getElementById('limit-warning').classList.add('hidden');
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.add('hidden');
            resultsDiv.classList.remove('flex');

            document.getElementById('error').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('query').value = queryName;

            try {
                const res = await fetch('/api/searches/' + searchId + '/leads', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (!res.ok || !data.success) throw new Error(data.message);
                currentLeads = data.leads;

                applyFilters();

                document.getElementById('results').classList.remove('hidden');
                document.getElementById('results').classList.add('flex');
            } catch (error) {
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error').classList.remove('hidden');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // ---------------- EXPORTA√á√ïES ----------------

        function downloadJSON() {
            if (!filteredLeads || filteredLeads.length === 0) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(filteredLeads, null, 2));
            triggerDownload(dataStr, "leads.json");
        }

        function downloadCSV() {
            if (!filteredLeads || filteredLeads.length === 0) return;
            const header = Object.keys(filteredLeads[0]).join(';');
            const rows = filteredLeads.map(lead => Object.values(lead).map(v => '"' + String(v).replace(/"/g, '""').replace(/\n/g, ' ') + '"').join(';'));
            const csvContent = [header, ...rows].join('\n');
            const dataStr = "data:text/csv;charset=utf-8,\uFEFF" + encodeURIComponent(csvContent);
            triggerDownload(dataStr, "leads.csv");
        }

        function triggerDownload(dataUri, filename) {
            const anchor = document.createElement('a');
            anchor.setAttribute('href', dataUri);
            anchor.setAttribute('download', filename);
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        }
    </script>
</body>

</html>